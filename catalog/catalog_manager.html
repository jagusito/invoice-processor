<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            text-align: center;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .tab-container {
            display: flex;
            margin-bottom: 2rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            background: white;
            color: #64748b;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: #f8fafc;
        }

        .tab-btn:hover {
            background: #f1f5f9;
        }

        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .form-section h3 {
            color: #1e293b;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        .search-bar {
            margin-bottom: 1rem;
            padding: 0.75rem;
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280;
        }

        .close:hover {
            color: #374151;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fef2f2;
            color: #991b1b;
        }

        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .no-data {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        /* Vendor Mapping specific styles */
        .mapping-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .selected-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .help-text {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Catalog Management System</h1>
            <p>Manage Entity and Vendor Catalogs for Invoice Processing - Connected to Snowflake</p>
        </div>

        <a href="/" class="back-btn">‚Üê Back to Dashboard</a>

        <div class="tab-container">
            <button class="tab-btn active" onclick="switchTab('entities')">Entity Catalog</button>
            <button class="tab-btn" onclick="switchTab('vendors')">Vendor Catalog</button>
            <button class="tab-btn" onclick="switchTab('mappings')">Entity-Vendor Mappings</button>
        </div>

        <!-- Entity Catalog Tab -->
        <div id="entities" class="tab-content active">
            <div class="form-section">
                <h3>Add New Entity</h3>
                <form id="entityForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="entityName">Entity Name *</label>
                            <input type="text" id="entityName" name="entityName" required>
                        </div>
                        <div class="form-group">
                            <label for="entityCode">Entity Code *</label>
                            <input type="text" id="entityCode" name="entityCode" required>
                        </div>
                        <div class="form-group">
                            <label for="entityType">Entity Type</label>
                            <select id="entityType" name="entityType">
                                <option value="">Select Type</option>
                                <option value="Customer">Customer</option>
                                <option value="Partner">Partner</option>
                                <option value="Subsidiary">Subsidiary</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="entityStatus">Status</label>
                            <select id="entityStatus" name="entityStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="entityAddress">Address</label>
                            <textarea id="entityAddress" name="entityAddress" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="entityContact">Contact Person</label>
                            <input type="text" id="entityContact" name="entityContact">
                        </div>
                        <div class="form-group">
                            <label for="entityEmail">Email</label>
                            <input type="email" id="entityEmail" name="entityEmail">
                        </div>
                        <div class="form-group">
                            <label for="entityPhone">Phone</label>
                            <input type="tel" id="entityPhone" name="entityPhone">
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" onclick="handleAddEntity(event)">Add Entity</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('entityForm')">Clear</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>Entity List</h3>
                <input type="text" class="search-bar" placeholder="Search entities..." onkeyup="searchTable('entitiesTable', this.value)">
                <div id="entitiesAlert"></div>
                <table class="data-table" id="entitiesTable">
                    <thead>
                        <tr>
                            <th>Entity Name</th>
                            <th>Code</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="entitiesTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading entities...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Vendor Catalog Tab -->
        <div id="vendors" class="tab-content">
            <div class="form-section">
                <h3>Add New Vendor</h3>
                <form id="vendorForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="vendorName">Vendor Name *</label>
                            <input type="text" id="vendorName" name="vendorName" required>
                        </div>
                        <div class="form-group">
                            <label for="vendorType">Vendor Type</label>
                            <select id="vendorType" name="vendorType">
                                <option value="">Select Type</option>
                                <option value="Service Provider">Service Provider</option>
                                <option value="Contractor">Contractor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vendorStatus">Status</label>
                            <select id="vendorStatus" name="vendorStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="vendorAddress">Address</label>
                            <textarea id="vendorAddress" name="vendorAddress" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="vendorContact">Contact Person</label>
                            <input type="text" id="vendorContact" name="vendorContact">
                        </div>
                        <div class="form-group">
                            <label for="vendorEmail">Email</label>
                            <input type="email" id="vendorEmail" name="vendorEmail">
                        </div>
                        <div class="form-group">
                            <label for="vendorPhone">Phone</label>
                            <input type="tel" id="vendorPhone" name="vendorPhone">
                        </div>
                        <div class="form-group">
                            <label for="vendorCurrency">Currency</label>
                            <select id="vendorCurrency" name="vendorCurrency">
                                <option value="">Select Currency</option>
                                <option value="USD">USD - US Dollar</option>
                                <option value="EUR">EUR - Euro</option>
                                <option value="GBP">GBP - British Pound</option>
                                <option value="CAD">CAD - Canadian Dollar</option>
                                <option value="AUD">AUD - Australian Dollar</option>
                                <option value="SGD">SGD - Singapore Dollar</option>
                                <option value="JPY">JPY - Japanese Yen</option>
                                <option value="CHF">CHF - Swiss Franc</option>
                                <option value="PGK">PGK - Papua New Guinean Kina</option>
                                <option value="CNY">CNY - Chinese Yuan</option>
								
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" onclick="handleAddVendor(event)">Add Vendor</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('vendorForm')">Clear</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>Vendor List</h3>
                <input type="text" class="search-bar" placeholder="Search vendors..." onkeyup="searchTable('vendorsTable', this.value)">
                <div id="vendorsAlert"></div>
                <table class="data-table" id="vendorsTable">
                    <thead>
                        <tr>
                            <th>Vendor Name</th>
                            <th>Type</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Contact</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading vendors...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Entity-Vendor Mappings Tab -->
        <div id="mappings" class="tab-content">
            <div class="mapping-info">
                <strong>Entity-Vendor Mappings</strong><br>
                Map entities to vendors with their specific vendor codes. Each entity assigns different vendor codes to the same provider based on their internal ERP systems.
            </div>

            <div class="form-section">
                <h3>Add New Entity-Vendor Mapping</h3>
                <form id="mappingForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="mappingEntity">Entity *</label>
                            <select id="mappingEntity" name="mappingEntity" required onchange="updateEntityInfo()">
                                <option value="">Select Entity</option>
                            </select>
                            <div id="selectedEntityInfo" class="selected-info" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="mappingVendor">Vendor *</label>
                            <select id="mappingVendor" name="mappingVendor" required onchange="updateVendorInfo()">
                                <option value="">Select Vendor</option>
                            </select>
                            <div id="selectedVendorInfo" class="selected-info" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="mappingVendorCode">Entity's Vendor Code *</label>
                            <input type="text" id="mappingVendorCode" name="mappingVendorCode" required placeholder="e.g., V1002-100115">
                            <div id="vendorCodeHelp" class="help-text">Enter the vendor code as it appears in the selected entity's ERP system</div>
                        </div>
                        <div class="form-group">
                            <label for="mappingStatus">Status</label>
                            <select id="mappingStatus" name="mappingStatus">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" onclick="handleAddMapping(event)">Add Mapping</button>
                        <button type="button" class="btn btn-secondary" onclick="clearForm('mappingForm')">Clear</button>
                    </div>
                </form>
            </div>

            <div class="form-section">
                <h3>Entity-Vendor Mappings</h3>
                <input type="text" class="search-bar" placeholder="Search mappings..." onkeyup="searchTable('mappingsTable', this.value)">
                <div id="mappingsAlert"></div>
                <table class="data-table" id="mappingsTable">
                    <thead>
                        <tr>
                            <th>Entity Name</th>
                            <th>Vendor Name</th>
                            <th>Entity's Vendor Code</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mappingsTableBody">
                        <tr>
                            <td colspan="6" class="loading">Loading mappings...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle">Edit Record</h3>
            <form id="editForm">
                <div id="editFormFields"></div>
                <div class="button-group">
                    <button type="submit" class="btn btn-success" onclick="handleUpdate(event)">Update</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration - Use API mode for Snowflake integration
        const OFFLINE_MODE = false;
        const API_BASE_URL = '/catalog/api';  // Adjust port as needed

        // Global variables
        let currentEditId = null;
        let currentEditType = null;
        let entitiesData = [];
        let vendorsData = [];

        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(tab => tab.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load mappings data when switching to mappings tab
            if (tabName === 'mappings') {
                loadMappings();
                loadDropdownData();
            }
        }

        // Button handlers
        function handleAddEntity(event) {
            event.preventDefault();
            addEntity();
            return false;
        }

        function handleAddVendor(event) {
            event.preventDefault();
            addVendor();
            return false;
        }

        function handleAddMapping(event) {
            event.preventDefault();
            addMapping();
            return false;
        }

        function handleUpdate(event) {
            event.preventDefault();
            updateRecord();
            return false;
        }

        // =====================================================
        // VENDOR MAPPING FUNCTIONS
        // =====================================================

        function loadDropdownData() {
            // Load entities for dropdown
            fetch(`${API_BASE_URL}/entities-for-dropdown`)
            .then(response => response.json())
            .then(entities => {
                const entitySelect = document.getElementById('mappingEntity');
                entitySelect.innerHTML = '<option value="">Select Entity</option>';
                entities.forEach(entity => {
                    entitySelect.innerHTML += `<option value="${entity.id}">${entity.display}</option>`;
                });
            })
            .catch(error => {
                console.error('Error loading entities for dropdown:', error);
            });

            // Load vendors for dropdown
            fetch(`${API_BASE_URL}/vendors-for-dropdown`)
            .then(response => response.json())
            .then(vendors => {
                const vendorSelect = document.getElementById('mappingVendor');
                vendorSelect.innerHTML = '<option value="">Select Vendor</option>';
                vendors.forEach(vendor => {
                    vendorSelect.innerHTML += `<option value="${vendor.id}">${vendor.display}</option>`;
                });
            })
            .catch(error => {
                console.error('Error loading vendors for dropdown:', error);
            });
        }

        function updateEntityInfo() {
            const entitySelect = document.getElementById('mappingEntity');
            const entityInfo = document.getElementById('selectedEntityInfo');
            const vendorCodeHelp = document.getElementById('vendorCodeHelp');
            
            if (entitySelect.value) {
                const selectedText = entitySelect.options[entitySelect.selectedIndex].text;
                const entityName = selectedText.split(' - ')[1];
                entityInfo.textContent = `Selected: ${selectedText}`;
                entityInfo.style.display = 'block';
                vendorCodeHelp.textContent = `Enter the vendor code as it appears in ${entityName}'s ERP system`;
            } else {
                entityInfo.style.display = 'none';
                vendorCodeHelp.textContent = 'Enter the vendor code as it appears in the selected entity\'s ERP system';
            }
        }

        function updateVendorInfo() {
            const vendorSelect = document.getElementById('mappingVendor');
            const vendorInfo = document.getElementById('selectedVendorInfo');
            
            if (vendorSelect.value) {
                const selectedText = vendorSelect.options[vendorSelect.selectedIndex].text;
                vendorInfo.textContent = `Selected: ${selectedText}`;
                vendorInfo.style.display = 'block';
            } else {
                vendorInfo.style.display = 'none';
            }
        }

        function addMapping() {
            const form = document.getElementById('mappingForm');
            const formData = new FormData(form);
            
            const mapping = {
                entity_id: formData.get('mappingEntity'),
                vendor_name: formData.get('mappingVendor'),
                entity_vendor_code: formData.get('mappingVendorCode'),
                status: formData.get('mappingStatus')
            };

            // Validate required fields
            if (!mapping.entity_id || !mapping.vendor_name || !mapping.entity_vendor_code) {
                showAlert('mappingsAlert', 'Entity, vendor, and vendor code are required!', 'error');
                return;
            }
            
            // Send to API
            fetch(`${API_BASE_URL}/vendor-mappings`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(mapping)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    form.reset();
                    document.getElementById('selectedEntityInfo').style.display = 'none';
                    document.getElementById('selectedVendorInfo').style.display = 'none';
                    showAlert('mappingsAlert', 'Vendor mapping added successfully!', 'success');
                    loadMappings();
                } else {
                    showAlert('mappingsAlert', data.error || 'Failed to add mapping', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('mappingsAlert', 'Error adding mapping: ' + error.message, 'error');
            });
        }

        function loadMappings() {
            fetch(`${API_BASE_URL}/vendor-mappings`)
            .then(response => response.json())
            .then(mappings => {
                renderMappingsTable(mappings);
            })
            .catch(error => {
                console.error('Error loading mappings:', error);
                showAlert('mappingsAlert', 'Error loading mappings: ' + error.message, 'error');
                document.getElementById('mappingsTableBody').innerHTML = '<tr><td colspan="6" class="no-data">Error loading mappings</td></tr>';
            });
        }

        function renderMappingsTable(mappings) {
            const tbody = document.getElementById('mappingsTableBody');
            
            if (!mappings || mappings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No vendor mappings found. Add your first mapping above.</td></tr>';
                return;
            }

            tbody.innerHTML = mappings.map(mapping => `
                <tr>
                    <td>${mapping.entity_name || mapping.entity_id}</td>
                    <td>${mapping.vendor_name || mapping.vendor_name}</td>
                    <td><strong>${mapping.entity_vendor_code}</strong></td>
                    <td>${mapping.vendor_currency || ''}</td>
                    <td><span class="status-badge ${mapping.status === 'Active' ? 'status-active' : 'status-inactive'}">${mapping.status}</span></td>
                    <td>
                        <button class="btn btn-secondary" onclick="editMapping('${mapping.mapping_id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteMapping('${mapping.mapping_id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function editMapping(mappingId) {
            currentEditId = mappingId;
            currentEditType = 'mapping';
            
            fetch(`${API_BASE_URL}/vendor-mappings`)
            .then(response => response.json())
            .then(mappings => {
                const mapping = mappings.find(m => m.mapping_id === mappingId);
                if (mapping) {
                    showEditModal(mapping, 'mapping');
                } else {
                    alert('Mapping not found');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading mapping data: ' + error.message);
            });
        }

        function deleteMapping(mappingId) {
            if (confirm('Are you sure you want to delete this vendor mapping? This action cannot be undone.')) {
                fetch(`${API_BASE_URL}/vendor-mappings/${mappingId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('mappingsAlert', 'Vendor mapping deleted successfully!', 'success');
                        loadMappings();
                    } else {
                        showAlert('mappingsAlert', data.error || 'Failed to delete mapping', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('mappingsAlert', 'Error deleting mapping: ' + error.message, 'error');
                });
            }
        }

        // Add entity function
        function addEntity() {
            const form = document.getElementById('entityForm');
            const formData = new FormData(form);
            
            const entity = {
                code: formData.get('entityCode'),
                name: formData.get('entityName'),
                type: formData.get('entityType'),
                status: formData.get('entityStatus'),
                address: formData.get('entityAddress'),
                contact: formData.get('entityContact'),
                email: formData.get('entityEmail'),
                phone: formData.get('entityPhone')
            };

            // Validate required fields
            if (!entity.code || !entity.name) {
                showAlert('entitiesAlert', 'Entity code and name are required!', 'error');
                return;
            }
            
            // Send to API
            fetch(`${API_BASE_URL}/entities`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(entity)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    form.reset();
                    showAlert('entitiesAlert', 'Entity added successfully!', 'success');
                    loadEntities();
                } else {
                    showAlert('entitiesAlert', data.error || 'Failed to add entity', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('entitiesAlert', 'Error adding entity: ' + error.message, 'error');
            });
        }

        // Add vendor function
        function addVendor() {
            const form = document.getElementById('vendorForm');
            const formData = new FormData(form);
            
            const vendor = {
                name: formData.get('vendorName'),
                type: formData.get('vendorType'),
                status: formData.get('vendorStatus'),
                address: formData.get('vendorAddress'),
                contact: formData.get('vendorContact'),
                email: formData.get('vendorEmail'),
                phone: formData.get('vendorPhone'),
                currency: formData.get('vendorCurrency')
            };

            // Validate required fields - removed code requirement
            if (!vendor.name) {
                showAlert('vendorsAlert', 'Vendor name is required!', 'error');
                return;
            }
            
            // Send to API
            fetch(`${API_BASE_URL}/vendors`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(vendor)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    form.reset();
                    showAlert('vendorsAlert', 'Vendor added successfully!', 'success');
                    // Force reload vendors after a short delay
                    setTimeout(() => {
                        loadVendors();
                    }, 100);
                } else {
                    showAlert('vendorsAlert', data.error || 'Failed to add vendor', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('vendorsAlert', 'Error adding vendor: ' + error.message, 'error');
            });
        }

        // Load entities from API
        function loadEntities() {
            console.log('Loading entities from:', `${API_BASE_URL}/entities`);
            fetch(`${API_BASE_URL}/entities`)
            .then(response => {
                console.log('Entities response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.log('Entities error response:', text);
                        throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}...`);
                    });
                }
                return response.json();
            })
            .then(entities => {
                entitiesData = entities;
                renderEntitiesTable(entities);
            })
            .catch(error => {
                console.error('Error loading entities:', error);
                showAlert('entitiesAlert', 'Error loading entities: ' + error.message, 'error');
                document.getElementById('entitiesTableBody').innerHTML = '<tr><td colspan="6" class="no-data">Error loading entities</td></tr>';
            });
        }

        // Load vendors from API - WITH DEBUGGING  
        function loadVendors() {
            console.log('üîç Loading vendors from:', `${API_BASE_URL}/vendors`);
            fetch(`${API_BASE_URL}/vendors`)
            .then(response => {
                console.log('üîç Vendors response status:', response.status);
                console.log('üîç Vendors response:', response);
                return response.json();
            })
            .then(vendors => {
                console.log('üîç Vendors data received:', vendors);
                vendorsData = vendors;
                renderVendorsTable(vendors);
            })
            .catch(error => {
                console.error('‚ùå Error loading vendors:', error);
                showAlert('vendorsAlert', 'Error loading vendors: ' + error.message, 'error');
                document.getElementById('vendorsTableBody').innerHTML = '<tr><td colspan="6" class="no-data">Error loading vendors</td></tr>';
            });
        }

        // Render entities table
        function renderEntitiesTable(entities) {
            const tbody = document.getElementById('entitiesTableBody');
            
            if (!entities || entities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No entities found. Add your first entity above.</td></tr>';
                return;
            }

            tbody.innerHTML = entities.map(entity => `
                <tr>
                    <td>${entity.name}</td>
                    <td>${entity.entity_id}</td>
                    <td>${entity.type || ''}</td>
                    <td><span class="status-badge ${entity.status === 'Active' ? 'status-active' : 'status-inactive'}">${entity.status}</span></td>
                    <td>${entity.contact || ''}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editEntity('${entity.entity_id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteEntity('${entity.entity_id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Render vendors table - FINAL FIX
        function renderVendorsTable(vendors) {
            const tbody = document.getElementById('vendorsTableBody');
            
            if (!vendors || vendors.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No vendors found. Add your first vendor above.</td></tr>';
                return;
            }

            tbody.innerHTML = vendors.map(vendor => `
                <tr>
                    <td>${vendor.name}</td>
                    <td>${vendor.type || ''}</td>
                    <td>${vendor.currency || ''}</td>
                    <td><span class="status-badge ${vendor.status === 'Active' ? 'status-active' : 'status-inactive'}">${vendor.status}</span></td>
                    <td>${vendor.contact || ''}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editVendor(\`${vendor.name}\`)">Edit</button>
                        <button class="btn btn-danger" onclick="deleteVendor(\`${vendor.name}\`)">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Edit entity function
        function editEntity(entityId) {
            currentEditId = entityId;
            currentEditType = 'entity';
            
            const entity = entitiesData.find(e => e.entity_id === entityId);
            if (entity) {
                showEditModal(entity, 'entity');
            } else {
                alert('Entity not found');
            }
        }

        // Edit vendor function - FIXED VARIABLE NAMES
        function editVendor(vendorName) {
            currentEditId = vendorName;  // Use vendor name as ID
            currentEditType = 'vendor';
            
            const vendor = vendorsData.find(v => v.name === vendorName);  // Search by name
            if (vendor) {
                showEditModal(vendor, 'vendor');
            } else {
                alert('Vendor not found');
            }
        }

        // Show edit modal
        function showEditModal(record, type) {
            document.getElementById('modalTitle').textContent = `Edit ${type === 'entity' ? 'Entity' : type === 'vendor' ? 'Vendor' : 'Mapping'}`;
            
            if (type === 'mapping') {
                // Handle mapping edit differently
                const formFields = document.getElementById('editFormFields');
                formFields.innerHTML = `
                    <div class="form-group">
                        <label>Entity</label>
                        <input type="text" value="${record.entity_name} (${record.entity_id})" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" value="${record.vendor_name}" readonly style="background-color: #f8f9fa;">
                    </div>
                    <div class="form-group">
                        <label for="editentity_vendor_code">Entity's Vendor Code *</label>
                        <input type="text" id="editentity_vendor_code" name="entity_vendor_code" value="${record.entity_vendor_code}" required>
                    </div>
                    <div class="form-group">
                        <label for="editstatus">Status</label>
                        <select id="editstatus" name="status">
                            <option value="Active" ${record.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Inactive" ${record.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                `;
            } else {
                const fields = type === 'entity' ? 
                    ['name', 'code', 'type', 'status', 'address', 'contact', 'email', 'phone'] :
                    ['name', 'type', 'status', 'address', 'contact', 'email', 'phone', 'currency']; // Removed 'code' for vendors
                
                const typeOptions = type === 'entity' ? 
                    ['Customer', 'Partner', 'Subsidiary'] :
                    ['Service Provider', 'Contractor'];
                
                const fieldLabels = {
                    name: `${type === 'entity' ? 'Entity' : 'Vendor'} Name`,
                    code: `${type === 'entity' ? 'Entity' : 'Vendor'} Code`,
                    type: `${type === 'entity' ? 'Entity' : 'Vendor'} Type`,
                    status: 'Status',
                    address: 'Address',
                    contact: 'Contact Person',
                    email: 'Email',
                    phone: 'Phone',
                    currency: 'Currency'
                };
                
                const formFields = document.getElementById('editFormFields');
                formFields.innerHTML = fields.map(field => {
                    const fieldValue = type === 'entity' ? 
                        (field === 'code' ? record.entity_id : record[field]) :
                        record[field];  // For vendors, just use record[field] since using vendor name
                        
                    if (field === 'type') {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <select id="edit${field}" name="${field}">
                                    <option value="">Select Type</option>
                                    ${typeOptions.map(option => 
                                        `<option value="${option}" ${fieldValue === option ? 'selected' : ''}>${option}</option>`
                                    ).join('')}
                                </select>
                            </div>
                        `;
                    } else if (field === 'status') {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <select id="edit${field}" name="${field}">
                                    <option value="Active" ${fieldValue === 'Active' ? 'selected' : ''}>Active</option>
                                    <option value="Inactive" ${fieldValue === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                </select>
                            </div>
                        `;
                    } else if (field === 'currency' && type === 'vendor') {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <select id="edit${field}" name="${field}">
                                    <option value="">Select Currency</option>
                                    <option value="USD" ${fieldValue === 'USD' ? 'selected' : ''}>USD - US Dollar</option>
                                    <option value="EUR" ${fieldValue === 'EUR' ? 'selected' : ''}>EUR - Euro</option>
                                    <option value="GBP" ${fieldValue === 'GBP' ? 'selected' : ''}>GBP - British Pound</option>
                                    <option value="CAD" ${fieldValue === 'CAD' ? 'selected' : ''}>CAD - Canadian Dollar</option>
                                    <option value="AUD" ${fieldValue === 'AUD' ? 'selected' : ''}>AUD - Australian Dollar</option>
                                    <option value="SGD" ${fieldValue === 'SGD' ? 'selected' : ''}>SGD - Singapore Dollar</option>
                                    <option value="JPY" ${fieldValue === 'JPY' ? 'selected' : ''}>JPY - Japanese Yen</option>
                                    <option value="CHF" ${fieldValue === 'CHF' ? 'selected' : ''}>CHF - Swiss Franc</option>
                                    <option value="PGK" ${fieldValue === 'PGK' ? 'selected' : ''}>PGK - Papua New Guinean Kina</option>									
                                    <option value="CNY" ${fieldValue === 'CNY' ? 'selected' : ''}>CNY - Chinese Yuan</option>
                                </select>
                            </div>
                        `;
                    } else if (field === 'address') {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <textarea id="edit${field}" name="${field}" rows="3">${fieldValue || ''}</textarea>
                            </div>
                        `;
                    } else if (field === 'code') {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <input type="text" id="edit${field}" name="${field}" value="${fieldValue || ''}" readonly style="background-color: #f8f9fa;">
                                <small style="color: #666;">Code cannot be changed after creation</small>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="form-group">
                                <label for="edit${field}">${fieldLabels[field]}</label>
                                <input type="${field === 'email' ? 'email' : field === 'phone' ? 'tel' : 'text'}" 
                                       id="edit${field}" name="${field}" value="${fieldValue || ''}"
                                       ${field === 'name' ? 'required' : ''}>
                            </div>
                        `;
                    }
                }).join('');
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Update record function
        function updateRecord() {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            
            const updatedData = {};
            for (let [key, value] of formData.entries()) {
                updatedData[key] = value;
            }

            // Validate required fields
            if (currentEditType === 'mapping') {
                if (!updatedData.entity_vendor_code) {
                    alert('Vendor code is required');
                    return;
                }
            } else {
                if (!updatedData.name) {
                    alert(`${currentEditType === 'entity' ? 'Entity' : 'Vendor'} name is required`);
                    return;
                }
            }

            const endpoint = currentEditType === 'entity' ? 'entities' : 
                           currentEditType === 'vendor' ? 'vendors' : 'vendor-mappings';
            
            // For vendors, use encodeURIComponent to handle spaces in names
            const urlId = currentEditType === 'vendor' ? encodeURIComponent(currentEditId) : currentEditId;
            
            fetch(`${API_BASE_URL}/${endpoint}/${urlId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    closeModal();
                    if (currentEditType === 'entity') {
                        showAlert('entitiesAlert', 'Entity updated successfully!', 'success');
                        loadEntities();
                    } else if (currentEditType === 'vendor') {
                        showAlert('vendorsAlert', 'Vendor updated successfully!', 'success');
                        loadVendors();
                    } else {
                        showAlert('mappingsAlert', 'Mapping updated successfully!', 'success');
                        loadMappings();
                    }
                } else {
                    alert(data.error || `Failed to update ${currentEditType}`);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error updating ${currentEditType}: ` + error.message);
            });
        }

        // Delete entity
        function deleteEntity(entityId) {
            if (confirm('Are you sure you want to delete this entity? This action cannot be undone.')) {
                fetch(`${API_BASE_URL}/entities/${entityId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('entitiesAlert', 'Entity deleted successfully!', 'success');
                        loadEntities();
                    } else {
                        showAlert('entitiesAlert', data.error || 'Failed to delete entity', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('entitiesAlert', 'Error deleting entity: ' + error.message, 'error');
                });
            }
        }

        // Delete vendor
        function deleteVendor(vendorName) {
            if (confirm('Are you sure you want to delete this vendor? This action cannot be undone.')) {
                fetch(`${API_BASE_URL}/vendors/${encodeURIComponent(vendorName)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('vendorsAlert', 'Vendor deleted successfully!', 'success');
                        loadVendors();
                    } else {
                        showAlert('vendorsAlert', data.error || 'Failed to delete vendor', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('vendorsAlert', 'Error deleting vendor: ' + error.message, 'error');
                });
            }
        }

        // Close modal function
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
            currentEditType = null;
        }

        // Utility functions
        function searchTable(tableId, searchTerm) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;
                
                for (let j = 0; j < cells.length - 1; j++) {
                    if (cells[j].textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                        found = true;
                        break;
                    }
                }
                
                rows[i].style.display = found ? '' : 'none';
            }
        }

        function clearForm(formId) {
            document.getElementById(formId).reset();
            if (formId === 'mappingForm') {
                document.getElementById('selectedEntityInfo').style.display = 'none';
                document.getElementById('selectedVendorInfo').style.display = 'none';
            }
        }

        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadEntities();
            loadVendors();
        });
    </script>
</body>
</html>